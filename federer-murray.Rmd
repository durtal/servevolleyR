---
title: "Wimbledon 2015"
---

### Federer vs Murray

Today Andy Murray faces Roger Federer in the semi-final of Wimbledon 2015.  This post will, like the [Williams vs Sharapova](williams-sharapova.html) from yesterday, look at some of the functionality of the package, focussing on [`simMatches`](simMatches.html) and [`simDf`](simDf.html).

Make sure the package is installed and loaded...

```{r warning=FALSE, message=FALSE}
# devtools::install_github("durtal/servevolleyR")
library(servevolleyR)
```

We need to estimate the probability that each player will win a point on his first serve, second serve, and the probability that his first serve will be in.  To do this, the simplest way is to use serve statistics shown on each of the players ATP pages, [Federer](http://www.atpworldtour.com/en/players/roger-federer/f324/player-stats?year=2015&surfaceType=grass) and [Murray](http://www.atpworldtour.com/en/players/andy-murray/mc10/player-stats?year=2015&surfaceType=grass), filtered to this year, and played on grass, Federer has 59 service games, and Murray 57.

```{r}
federer1 <- .83    # federer first serve win %
federer2 <- .51    # federer second serve win %
federerIn <- .70   # federer first serve in %

murray1 <- .81     # murray first serve win %
murray2 <- .57     # murray second serve win %
murrayIn <- .67    # murray first serve in %
```

First a couple of plots that look at each players service games:

<div class="row">
<div class="col-sm-6">

<h3 style="text-align: center">Federer</h3>

```{r cache=TRUE}
federerGames <- simGames(n = 1e4,
                         p = federer1,
                         p2 = federer2,
                         firstServe = federerIn)

federerGames
```

Federer won **`r federerGames$results$pct`** of his service games, in 2015 (according to the link above) he actually won **0.97** of service games.  The score in each of the simulated service games is plotted below.

```{r}
plot(federerGames)
```

</div>
<div class="col-sm-6">

<h3 style="text-align: center">Murray</h3>

```{r cache=TRUE}
murrayGames <- simGames(n = 1e4,
                        p = murray1,
                        p2 = murray2,
                        firstServe = murrayIn)

murrayGames
```

Murray won **`r murrayGames$results$pct`** of his service games, in 2015 (according to the link above) he actually won **0.91** of service games.  The score in each of the simulated service games is plotted below.

```{r}
plot(murrayGames)
```

</div>
</div>

### `simMatches`

Rather than simulate sets as well, I'll jump straight to [`simMatches`](simMatches.html) and simulate 1000 matches between Federer and Murray.  It is followed by a summary of those 1000 matches on the left, and a plot on the right, showing the match scores.

```{r cache=TRUE}
fedmur <- simMatches(n = 1e3, sets = 5, tiebreaks = TRUE, finalSetTiebreak = TRUE,
                     pA = federer1, p2A = federer2, firstServeA = federerIn,
                     pB = murray1, p2B = murray2, firstServeB = murrayIn,
                     players = c("Federer", "Murray"))
```

<div class="row">
<div class="col-sm-6">

Federer wins **`r fedmur$results$pct`** of matches between the two.  Prices on Betfair put Federer's chance of winning at 0.47.

```{r}
summary(fedmur)
```

</div>
<div class="col-sm-6">

```{r}
plot(fedmur)
```

</div>
</div>

Using `simMatches` means that each simulated set has at least 3 simulated sets, and at most 5 simulated sets.  So 1000 Match simulations contains between 3000 and 5000 simulated sets.  Following that, each set will have been 6 and 12 simulated service games, this means that there is a huge amount of simulated data.  This data can be converted to a dataset using the [`simDf`](simDf.html) function, it can take some time to convert the list, so be patient.  `simDf` only takes one set argument, the list returned by `simMatches`, but supplying `.progress = "time"` will add `plyr`'s progress bar to show how long it should take (I won't add it here, but I will time the conversion).

```{r cache=TRUE}
start <- Sys.time()
fedmurDf <- simDf(fedmur)
finish <- Sys.time()
```

Converting this list took **`r diff(c(start, finish))`** minutes, showing that it can take some time, more simulations, the longer it takes, but we now have a dataset of **`r nrow(fedmurDf)`** rows and **`r ncol(fedmurDf)`** variables, explanation of these variables can be found at the bottom of the [`simMatches`](simMatches.html) page.

### Enter the `dplyr`

For manipulation of datasets, then `dplyr` is the best choice, and we'll use `ggplot2` for plotting.  Below we load the `dplyr` and `ggplot2` packages and filter the first set in the first simulation: the set ended in a tiebreak (`gameNo` goes up to 13), with Murray emerging as the winner of the set 7-6.

```{r warning=FALSE, message=FALSE}
library(dplyr)
library(ggplot2)

fedmurDf %>%
    filter(simNo == 1, setNo == 1)
```

We can use this dataset to establish the probability of set scores, depending on who opens the serving:

```{r}
setSummary <- fedmurDf %>%
    filter(gameNo == 1) %>%            # filter just gameNo == 1
    group_by(serving, setA, setB) %>%  # who serves first, and what were the scores
    summarise(n = n()) %>%             # count how many
    ungroup() %>%
    group_by(serving) %>%
    mutate(pct = n / sum(n))           # calculate proportion
```

Given their very similar service probabilities it's unsurprising to see set scores so tight, with a tiebreak estimated at around 0.5 regardless of who opens the serving.

<div class="row">
<div class="col-sm-6">

```{r echo=FALSE}
setSummary %>%
    filter(serving == "Federer") %>%
    ggplot(aes(x = setA, y = setB, fill = pct)) +
        geom_tile() +
        scale_fill_continuous(low = "lightblue", high = "#E50023", guide = FALSE) +
        geom_text(aes(label = round(pct, 3)), size = 4) +
        theme_minimal() +
        labs(x = paste0("Federer Games Won"),
             y = paste0("Murray Games Won"),
             title = paste0("Federer Serving First\nSet Scores"))
```

</div>
<div class="col-sm-6">

```{r echo=FALSE}
setSummary %>%
    filter(serving == "Murray") %>%
    ggplot(aes(x = setA, y = setB, fill = pct)) +
        geom_tile() +
        scale_fill_continuous(low = "lightblue", high = "#E50023", guide = FALSE) +
        geom_text(aes(label = round(pct, 3)), size = 4) +
        theme_minimal() +
        labs(x = paste0("Murray Games Won"),
             y = paste0("Federer Games Won"),
             title = paste0("Murray Serving First\nSet Scores"))
```

</div>
</div>

<a href="https://github.com/durtal/servevolleyR" class="github-corner"><svg width="80" height="80" viewBox="0 0 250 250" style="fill:#d9230f; color:#fcfcfc; position: absolute; top: 0; border: 0; right: 0;"><path d="M0,0 L115,115 L130,115 L142,142 L250,250 L250,0 Z"></path><path d="M128.3,109.0 C113.8,99.7 119.0,89.6 119.0,89.6 C122.0,82.7 120.5,78.6 120.5,78.6 C119.2,72.0 123.4,76.3 123.4,76.3 C127.3,80.9 125.5,87.3 125.5,87.3 C122.9,97.6 130.6,101.9 134.4,103.2" fill="currentColor" style="transform-origin: 130px 106px;" class="octo-arm"></path><path d="M115.0,115.0 C114.9,115.1 118.7,116.5 119.8,115.4 L133.7,101.6 C136.9,99.2 139.9,98.4 142.2,98.6 C133.8,88.0 127.5,74.4 143.8,58.0 C148.5,53.4 154.0,51.2 159.7,51.0 C160.3,49.4 163.2,43.6 171.4,40.1 C171.4,40.1 176.1,42.5 178.8,56.2 C183.1,58.6 187.2,61.8 190.9,65.4 C194.5,69.0 197.7,73.2 200.1,77.6 C213.8,80.2 216.3,84.9 216.3,84.9 C212.7,93.1 206.9,96.0 205.4,96.6 C205.1,102.4 203.0,107.8 198.3,112.5 C181.9,128.9 168.3,122.5 157.7,114.1 C157.9,116.9 156.7,120.9 152.7,124.9 L141.0,136.5 C139.8,137.7 141.6,141.9 141.8,141.8 Z" fill="currentColor" class="octo-body"></path></svg></a><style>.github-corner:hover .octo-arm{animation:octocat-wave 560ms ease-in-out}@keyframes octocat-wave{0%,100%{transform:rotate(0)}20%,60%{transform:rotate(-25deg)}40%,80%{transform:rotate(10deg)}}@media (max-width:500px){.github-corner:hover .octo-arm{animation:none}.github-corner .octo-arm{animation:octocat-wave 560ms ease-in-out}}</style>
